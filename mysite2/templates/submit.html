{% load static %}

<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Submit</title>
    <link rel="stylesheet" type="text/css" href="static/css/input02.css">
    <link rel="stylesheet" type="text/css" href="static/css/font-awesome-4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="static/js/ChemDoodle/ChemDoodleWeb.css" type="text/css">
    <link rel="stylesheet" href="static/js/ChemDoodle/uis/jquery-ui-1.11.4.css" type="text/css">

    <link rel="stylesheet" href="static/css/index.css">
    <link rel="stylesheet" href="static/css/loading.css">
    <script type="text/javascript" language="javascript" src="static/js/loading.js"></script>
    <script type="text/javascript" language="javascript" src="static/js/index.js"></script>

    <script type="text/javascript" src="static/js/ChemDoodle/ChemDoodleWeb.js"></script>
    <script type="text/javascript" src="static/js/ChemDoodle/uis/ChemDoodleWeb-uis.js"></script>
    <script type="text/javascript" src="static/js/RDKit/RDKit_minimal.js"></script>
    <script type="text/javascript" language="javascript" src="static/js/jQuery-3.4.1/jquery-3.4.1.js"></script>
    <script type="text/javascript" language="javascript" src="static/js/jQuery-3.4.1/jquery-cookie/jquery.cookie.js"></script>
    <script type="text/javascript" language="javascript" src="static/js/jsme/jsme.nocache.js"></script>
</head>
<body>

    {# navbar #}
    <div id="navlist">
        <header>
            <ul class="menulist">
                <li class="head">
                    <div id="name"><b>KIP</b>
                        <div class="hidden_item" style="display:none">
                             <a href="/kip"><i class="fa fa-home"></i> Home</a>
                             <a href="submit"><i class="fa fa-upload"></i> Submit</a>
                             <a href="help"><i class="fa fa-book"></i> Help</a>
                             <a href="contact"><i class="fa fa-envelope"></i> Contact</a>
                        </div>
                    </div>
                </li>
                <div class="item">
                        <li><a href="/kip"><i class="fa fa-home"></i> Home</a></li>
                        <li><a href="submit"><i class="fa fa-upload"></i> Submit</a></li>
                        <li><a href="help"><i class="fa fa-book"></i> Help</a></li>
                        <li><a href="contact"><i class="fa fa-envelope"></i> Contact</a></li>
                </div>

                <div style="float:right">
                    <li style="margin-top: 9px;"><button id="hidden_item_btn" class="icon"><i class="fa fa-bars"></i></button></li>
                </div>
            </ul>
        </header>
    </div>

    {# description #}
    <br>
    <br>
    <br>
    <br>
    <div class="wrapper" style="opacity: 1;
                                display:block;
                                ">
        <div class="loading-wrapper" style="z-index:1002;
                                            position:fixed
                                            "><div class="loading-view">
            <div class="container1">
                <div class="circle circle1"></div>
                <div class="circle circle2"></div>
                <div class="circle circle3"></div>
                <div class="circle circle4"></div>
            </div>
            <div class="container2">
                <div class="circle circle1"></div>
                <div class="circle circle2"></div>
                <div class="circle circle3"></div>
                <div class="circle circle4"></div>
            </div>
        </div><div class="tip-view">loading</div></div>
    </div>

    {% comment %} <div class="toast">
        <div class="load"></div>
        <div>load...</div>
    </div> {% endcomment %}
    
    <div class="subtitle">Submit | </div>
    <br>

     <div class="uploaded_scheme">
        <p class="description">
		
	<p><h4 class="pattern">1 Input Molecule By Drawing</h4>
           &nbsp&nbspYou can draw a molecule in <b class="tab">ChemDoodle Panel</b> and then submit it to the server by <b class="tab">Submit By Drawing Button</b>, and the server will return the <b class="page">Result Page</b> or <b class="invalid">some alerts</b> for the <b>invalid molecule</b>. 
	</p>
            <hr>
	
            <p><h4 class="pattern">2 Input SMILES</h4>
            &nbsp&nbspYou can input SMILES manually on <b class="tab">SMILES Input Window</b>.
            With a SMILES in <b>SMILES Input Window</b>, you can submit it to the server and the server will return the <b class="page">Result Page</b> or <b class="invalid">some alerts</b> for <b>invalid SMILES</b>.</p>
            <hr>

            <p><h4 class="pattern">3 Input File</h4>
            &nbsp&nbspYou can  click on <b class="tab">File Input Window</b> and input a <b>CSV File</b> or <b>SDF File</b>. 
            <b class="note">The CSV File must contain SMILES with the header named smiles</b>.<b> (An <b class="tab">Example CSV File</b> is provided for illustration. You can <b>download</b> this file by <b>clicking</b> on it.)</b> Only <b>one file</b> is available in <b class="tab">File Input Window</b>, and if multiple files are provided <b>only the last file</b> is available.
            With one file in <b class="tab">File Input Window</b>, you can submit it to the server and the server will return the <b class="page">Result Page</b> or <b class="invalid">some alerts</b> for <b>Invalid molecules</b>.</p>
            <hr>
            <p>If you have <b>multiple molecules</b> for computation, We recommend you pack them all together into an <b>SDF</b> file or a <b>CSV</b> file and then submit.</p>

            
            
        </p>
     </div>

    <br>

    <div>
        <div class="Draw">
                    
            {# Darw panel #}
            <div id="draw_panel" style="margin: 0 auto;
                                        background:white;
					border-radius: 0.25rem;
    					padding: 0.75rem;">
                {% comment %} <div name="jme" code="JME.class"  width=360 height=320 id="jmse">
                </div> {% endcomment %}
                <div>
                    <script>
                        ChemDoodle.ELEMENT['H'].jmolColor = 'black';
                        ChemDoodle.ELEMENT['S'].jmolColor = '#B9A130';
                        var sketcher = new ChemDoodle.SketcherCanvas('sketcher', 340, 320,{useServices:true, oneMolecule:true});
                        sketcher.specs.atoms_displayTerminalCarbonLabels_2D = true;
                        sketcher.specs.atoms_useJMOLColors = true;
                        sketcher.specs.bonds_clearOverlaps_2D = true;
                        sketcher.repaint();
                    </script>
                </div>

                <br>
                
                {# btn  #}
                <div>
                    <form action="result.html" method="post" onsubmit="return check_drawing()">
                        {%csrf_token%}
                        <input name="drawing" type="hidden" id="drawing">
                        <button class="btn btn_convert" type="buuton" onclick="convert_draw()">Submit by Drawing</button>
                    </form>
                </div>
            </div>
            
            


            {#   submit smiles  #}
            <div id="submit" style="width:45%;
                                    margin: 0 auto">
                <form action="result.html" method="post" onsubmit="return check_smiles()">
                    {%csrf_token%}{#csrf_token用来验证#}

                    <label for="smiles">
                        <p><i class="fa fa-pencil"></i>
                            <strong>By Inputting Smiles</strong>
                        </p>
                    </label>
                    <input type="text" name="smiles"
                                required maxlength="100"
                                minlength="1"
                                placeholder="Please input a SMILES"
                                id="smiles">
                    
                    <br>
                    
                    <button class="btn" type="button" onclick="example_input()"> Example</button>
                    <button class="btn" type="button" onclick="reset_smiles()">Reset</button>
                    <button class="btn" type="submit" id="btn_smiles" >Submit</button>
                        
                </form>
            
                
                <hr>

            
                <form action="result.html" method="post" enctype="multipart/form-data" onsubmit="return check_file()">
                    {%csrf_token%}{#csrf_token用来验证#}
                    {#https://www.cnblogs.com/honglingjin/articles/6588237.html#}
                    <div>
                        <div>
                            <div style="position: relative;
                                        bottom: 40px;">
                                <input type="file" id="file" name="file">
				<br> 
                                <label for="file">
				    <p>
					<i class="fa fa-upload" style="display: inline"></i>
                                    	<strong>By Uploading File(*csv,*sdf)</strong>
				    </p>
                                </label>
                               

                                <input type="text" placeholder="Please input a CSV or SDF file" id="file_show"style="z-index:-1;">
                                
                                <div class="example">
                                    <a href="static/file/example.csv" download="example.csv" id="example_csv">example.csv</a>
                                    <a href="static/file/example.sdf" download="example.sdf" id="example_sdf">example.sdf</a>
                                    <button id="btn_file" class="btn">Submit</button>
                                </div>

                                
                                
                            </div>
                        </div>
                        {% comment %} <span id="error_msg_file" style="color: red">msg</span> {% endcomment %}
                        
                    </div>
                </form>
            </div>

        </div>
    </div>

    


        



    
    <br>
    <br>
    <br>
    <br>
    

    <div id="foot">
        <footer>
            <p>
            © 2021 Tingjun Hou's Group. All Rights Reserved.
            </p>
        </footer>
    </div>



    <script LANGUAGE="JavaScript">
    

        $(document).ready( function(){
		    $(".wrapper").hide(500);
                    $("#hidden_item_btn").on("click",function(){
                        $(".hidden_item").toggle();
                    });
            })
    

        function example_input() {
            document.getElementById("smiles").value = "CN(C/C=C/C(NC1=C(C=C2N=CN=C(C2=C1)NC3=CC(Cl)=C(C=C3)F)O[C@H]4CCOC4)=O)C";
        }


        function getSmiles() {
            var mol = sketcher.getMolecule();
            mol_file =  ChemDoodle.writeMOL(mol);
            console.log(mol_file);
            console.log(typeof(mol_file));

        }


        function reset_smiles() {
                document.getElementById("smiles").value ='';
        };

        function convert_draw() {
            var mol = sketcher.getMolecule();
            document.getElementById("drawing").value = ChemDoodle.writeMOL(mol);
        };

        //jquery 
        $(function(){  
    
            //监听input
            $('#file').bind('input propertychange', function() {  
                var file= $('#file')[0].files[0];
                console.log(file.name);
                document.getElementById("file_show").value = file.name; 
            });  
            
            });

        


         function check_smiles(){
            var ajaxFlag=false;
            $(".wrapper").show(); 
            $.ajax({
                url:"result.html",
                type:"post",
                contentType: "application/json",
                async:false,
                cache:false,
                data:JSON.stringify({
                    "smiles":document.getElementById("smiles").value,
                }),
                headers:{'X-CSRFToken': $('input[name=csrfmiddlewaretoken]').val()},{#//在请求头通过csrf认证，键固定#}
                success:function(data){
                    
                     if (JSON.parse(data).status === 200){
                         ajaxFlag = true;
                     }
                     else{
                         alert(JSON.parse(data).error_msg);
			 document.getElementById("smiles").value="";
                     }
                }
            });
            $(".wrapper").hide(2000);
            return ajaxFlag
         };

         function check_drawing(){
            var ajaxFlag=false;
            $(".wrapper").show();
            $.ajax({
                url:"result.html",
                type:"post",
                contentType: "application/json",
                async:false,
                cache:false,
                data:JSON.stringify({
                    "drawing":document.getElementById("drawing").value,
                }),
                headers:{'X-CSRFToken': $('input[name=csrfmiddlewaretoken]').val()},{#//在请求头通过csrf认证，键固定#}
                success:function(data){
                    
                     if (JSON.parse(data).status === 200){
                         ajaxFlag = true;
                     }
                     else{
                         alert(JSON.parse(data).error_msg);
                     }
                }
            });
            $(".wrapper").hide(2000);
            return ajaxFlag
         };



          function check_file(){
            

            var file=$('#file')[0].files[0];

            if (file){
                var file_name = file.name;
                var type=(file_name.substr(file_name.lastIndexOf("."))).toLowerCase();
                

                if(type!=".csv"&&type!=".sdf"){
                    
                    alert("The type of the file you uploaded does not match (. CSV |. SDF)!");
                    return false;
                }

                else{
		    $(".wrapper").show();

                    var formdata = new FormData();
                    var ajaxFlag=false;

                    formdata.append("file",file);
                    formdata.append("file_name",file_name);
                    formdata.append("file_type",type);

                    $.ajax({
                    url:"result.html",
                    type:"post",
                    async:false,
                    cache: false,//上传文件无需缓存
                    processData: false,//用于对data参数进行序列化处理 这里必须false
                    contentType: false, //必须
                    headers:{'X-CSRFToken': $('input[name=csrfmiddlewaretoken]').val()},{#//在请求头通过csrf认证，键固定#}
                    data:formdata,
                    success:function(data){
                        
                        if (JSON.parse(data).status === 200){
                            ajaxFlag = true;
                        }else{alert(JSON.parse(data).error_msg);}}
                    });
		    $(".wrapper").hide(2000);

                    return ajaxFlag
                }

                }
            else{
                alert("Please upload the file!");
                return false;

            }
        }


    </script>


</body>
</html>
